const { sequelize } = require('../models')
const db = require('../models')
const { Question, User } = db

async function initializeDatabase() {
  try {
    // Проверка подключения к базе данных
    await sequelize.authenticate()
    console.log('Подключение к базе данных успешно установлено.')

    // Синхронизация моделей с базой данных
    await sequelize.sync({ alter: true })
    console.log('Модели успешно синхронизированы с базой данных.')

    // Проверка наличия суперадмина, создание если отсутствует
    const superAdminCount = await User.count({ where: { role: 'superadmin' } })
    if (superAdminCount === 0) {
      const defaultSuperAdmin = await User.create({
        username: 'superadmin',
        email: 'superadmin@example.com',
        password: 'superadmin123',
        role: 'superadmin'
      })
      console.log('Создан аккаунт суперадмина по умолчанию:', defaultSuperAdmin.username)
    } else {
      console.log('Аккаунт суперадмина уже существует.')
    }

    // Создание тестовых админов, если их нет
    const adminCount = await User.count({ where: { role: 'admin' } })
    if (adminCount === 0) {
      const defaultAdmin = await User.create({
        username: 'admin',
        email: 'admin@example.com',
        password: 'admin123',
        role: 'admin'
      })
      console.log('Создан аккаунт админа по умолчанию:', defaultAdmin.username)
    } else {
      console.log('Аккаунты админов уже существуют.')
    }

    // Создание тестовых данных, если таблица пуста
    const questionCount = await Question.count()
    if (questionCount === 0) {
      const sampleQuestions = [
        {
          question: 'Как часто следует проходить медицинский осмотр?',
          answer: 'Рекомендуется проходить полный медицинский осмотр раз в год. Людям старше 40 лет или с хроническими заболеваниями может потребоваться более частое обследование.',
          category: 'Профилактика'
        },
        {
          question: 'Как правильно измерять артериальное давление?',
          answer: 'Измеряйте давление в спокойной обстановке, сидя в удобном положении. Рука должна быть на уровне сердца. Не разговаривайте и не двигайтесь во время измерения. Проведите два измерения с интервалом в 1-2 минуты и возьмите среднее значение.',
          category: 'Диагностика'
        },
        {
          question: 'Какие продукты полезны для сердца?',
          answer: 'Полезны рыба (особенно жирная), орехи, оливковое масло, ягоды, зеленые овощи, цельнозерновые продукты и бобовые. Следует ограничить потребление насыщенных жиров, сахара и натрия.',
          category: 'Питание'
        },
        {
          question: 'Какие симптомы указывают на диабет?',
          answer: 'Основные симптомы диабета: частое мочеиспускание, сильная жажда, потеря веса, усталость, замедленное заживление ран, частые инфекции. При появлении этих симптомов следует обратиться к врачу.',
          category: 'Симптомы'
        },
        {
          question: 'Как правильно питаться при гипертонии?',
          answer: 'При гипертонии рекомендуется ограничить потребление соли до 5 г в день, увеличить потребление калия (бананы, апельсины, шпинат), есть больше овощей и фруктов, выбирать нежирные источники белка и ограничить алкоголь.',
          category: 'Питание'
        },
        {
          question: 'Какие упражнения полезны для суставов?',
          answer: 'Для суставов полезны низкоинтенсивные упражнения: плавание, ходьба, езда на велосипеде, йога, пилатес. Избегайте высокоинтенсивных нагрузок и упражнений с резкими движениями.',
          category: 'Фитнес'
        },
        {
          question: 'Как распознать симптомы инфаркта?',
          answer: 'Симптомы инфаркта: сильная боль или давление в груди, боль в руке, шее, челюсти или спине, одышка, тошнота, холодный пот, головокружение. При подозрении на инфаркт немедленно вызывайте скорую помощь.',
          category: 'Симптомы'
        },
        {
          question: 'Какие витамины важны для иммунитета?',
          answer: 'Для иммунитета важны витамины C, D, A, E, а также цинк и селен. Их можно получить из цитрусовых, ягод, овощей, орехов, рыбы и мяса. Лучше получать витамины из пищи, а не из добавок.',
          category: 'Питание'
        },
        {
          question: 'Как правильно спать для здоровья?',
          answer: 'Для здорового сна рекомендуется спать 7-9 часов, ложиться спать и вставать в одно и то же время, избегать кофеина и экранов за 2 часа до сна, создать темную и прохладную спальню, регулярно заниматься физическими упражнениями.',
          category: 'Образ жизни'
        },
        {
          question: 'Какие продукты следует избегать при аллергии?',
          answer: 'При аллергии следует избегать известных аллергенов. Часто вызывают аллергию: арахис, моллюски, яйца, молоко, соя, пшеница, рыба. Всегда читайте состав продуктов и консультируйтесь с врачом.',
          category: 'Питание'
        },
        {
          question: 'Как предотвратить остеопороз?',
          answer: 'Для профилактики остеопороза необходимо достаточное потребление кальция и витамина D, регулярные нагрузки на кости (ходьба, бег, поднятие тяжестей), отказ от курения и ограничение алкоголя.',
          category: 'Профилактика'
        },
        {
          question: 'Какие симптомы указывают на инсульт?',
          answer: 'Симптомы инсульта: внезапная слабость или онемение лица, руки или ноги (чаще с одной стороны), внезапная путаница в речи, потеря зрения, сильная головная боль, потеря равновесия. При подозрении на инсульт немедленно вызывайте скорую помощь.',
          category: 'Симптомы'
        },
        {
          question: 'Как правильно пить воду для здоровья?',
          answer: 'Рекомендуется пить 1.5-2 литра воды в день, пить воду регулярно в течение дня, а не большими порциями, пить воду за 30 минут до еды и через час после еды, выбирать чистую фильтрованную воду.',
          category: 'Питание'
        },
        {
          question: 'Какие продукты полезны для пищеварения?',
          answer: 'Для пищеварения полезны продукты с высоким содержанием клетчатки: фрукты, овощи, цельнозерновые продукты, бобовые. Также полезны йогурты с пробиотиками, квашеная капуста, имбирь и зеленый чай.',
          category: 'Питание'
        },
        {
          question: 'Как предотвратить простудные заболевания?',
          answer: 'Для профилактики простуды регулярно мойте руки, избегайте контакта с больными людьми, укрепляйте иммунитет правильным питанием и сном, проветривайте помещения и делайте прививки.',
          category: 'Профилактика'
        },
        {
          question: 'Какие упражнения полезны для спины?',
          answer: 'Для спины полезны упражнения на растяжку и укрепление мышц кора: йога, пилатес, плавание, ходьба. Избегайте тяжелых подъемов и резких движений.',
          category: 'Фитнес'
        },
        {
          question: 'Как правильно сидеть за компьютером?',
          answer: 'При работе за компьютером сядьте прямо, ноги на полу, спина прижата к спинке стула. Монитор должен быть на уровне глаз. Делайте перерывы каждые 30-60 минут для разминки.',
          category: 'Образ жизни'
        },
        {
          question: 'Какие продукты полезны для мозга?',
          answer: 'Для мозга полезны рыба с омега-3 жирными кислотами, орехи, ягоды, темный шоколад, авокадо, яйца, зеленые листовые овощи и зеленый чай.',
          category: 'Питание'
        },
        {
          question: 'Как измерить температуру тела правильно?',
          answer: 'Температуру можно измерить в подмышечной впадине, во рту или в прямой кишке. Перед измерением термометр должен быть чистым. Измеряйте не менее 3-5 минут. Нормальная температура 36.6°C ± 0.5°C.',
          category: 'Диагностика'
        },
        {
          question: 'Какие симптомы указывают на аллергию?',
          answer: 'Симптомы аллергии: чихание, заложенность носа, зуд в глазах, кожная сыпь, отеки, затрудненное дыхание. При тяжелых симптомах необходимо немедленно обратиться за медицинской помощью.',
          category: 'Симптомы'
        },
        {
          question: 'Как правильно ухаживать за зубами?',
          answer: 'Чистите зубы дважды в день, используйте зубную нить, ополаскиватель для рта. Меняйте зубную щетку каждые 3 месяца. Посещайте стоматолога раз в полгода.',
          category: 'Профилактика'
        },
        {
          question: 'Какие продукты полезны при анемии?',
          answer: 'При анемии полезны продукты с высоким содержанием железа: красное мясо, печень, шпинат, бобовые, сухофрукты, орехи. Употребляйте их вместе с продуктами, богатыми витамином C для лучшего усвоения.',
          category: 'Питание'
        },
        {
          question: 'Как предотвратить обезвоживание?',
          answer: 'Пейте достаточное количество воды в течение дня (1.5-2 литра), особенно в жару и при физических нагрузках. Увеличьте потребление жидкости при лихорадке, поносе и рвоте.',
          category: 'Образ жизни'
        }
      ]

      await Question.bulkCreate(sampleQuestions)
      console.log('Добавлены тестовые вопросы.')
    } else {
      console.log('Вопросы уже существуют в базе данных.')
    }

    console.log('Инициализация базы данных завершена успешно.')
  } catch (error) {
    console.error('Ошибка инициализации базы данных:', error)
  }
}

// Запуск инициализации, если файл запущен напрямую
if (require.main === module) {
  initializeDatabase()
}

module.exports = initializeDatabase